<!-- ======================================================================= -->
<!-- SKELETON LOADING (VISIBILE DURANTE IL CARICAMENTO)                      -->
<!-- ======================================================================= -->
<div *ngIf="isLoading" class="skeleton-container fade-out">
  <!-- Skeleton Hero -->
  <div class="skeleton-hero">
    <div class="skeleton-hero-overlay"></div>
    <!-- Sfumatura finta -->
    <div class="skeleton-hero-content">
      <div class="skeleton-title skeleton-box"></div>
      <div class="skeleton-meta skeleton-box"></div>
      <div class="skeleton-desc skeleton-box"></div>
      <div class="skeleton-controls">
        <div class="skeleton-btn skeleton-box"></div>
        <div class="skeleton-btn circle skeleton-box"></div>
      </div>
    </div>
  </div>

  <!-- Skeleton Episodes Section -->
  <div class="episodes-section skeleton-section">
    <!-- Header Finto -->
    <div class="episodes-header">
      <div class="skeleton-header-title skeleton-box"></div>
      <div class="skeleton-selector skeleton-box"></div>
    </div>

    <div class="episodes-content-wrapper">
      <!-- Lista Episodi Finta -->
      <div class="episodes-list">
        <!-- Generiamo 4 card fittizie -->
        <div class="skeleton-episode-card">
          <div class="skeleton-ep-thumb skeleton-box"></div>
          <div class="skeleton-ep-details">
            <div class="skeleton-text-line sm skeleton-box"></div>
            <div class="skeleton-text-line md skeleton-box"></div>
            <div class="skeleton-text-line lg skeleton-box"></div>
          </div>
        </div>
        <div class="skeleton-episode-card">
          <div class="skeleton-ep-thumb skeleton-box"></div>
          <div class="skeleton-ep-details">
            <div class="skeleton-text-line sm skeleton-box"></div>
            <div class="skeleton-text-line md skeleton-box"></div>
            <div class="skeleton-text-line lg skeleton-box"></div>
          </div>
        </div>
        <div class="skeleton-episode-card">
          <div class="skeleton-ep-thumb skeleton-box"></div>
          <div class="skeleton-ep-details">
            <div class="skeleton-text-line sm skeleton-box"></div>
            <div class="skeleton-text-line md skeleton-box"></div>
            <div class="skeleton-text-line lg skeleton-box"></div>
          </div>
        </div>
        <div class="skeleton-episode-card">
          <div class="skeleton-ep-thumb skeleton-box"></div>
          <div class="skeleton-ep-details">
            <div class="skeleton-text-line sm skeleton-box"></div>
            <div class="skeleton-text-line md skeleton-box"></div>
            <div class="skeleton-text-line lg skeleton-box"></div>
          </div>
        </div>
      </div>

      <!-- Pannello Laterale Finto (Solo Desktop) -->
      <div class="skeleton-panel mobile-hidden skeleton-box"></div>
    </div>
  </div>
</div>
<div
  *ngIf="!isLoading && selectedCategory"
  class="season-page-container fade-in"
>
  <!-- Sezione Hero del Formato -->
  <div class="format-hero">
    <img
      [src]="
        isMobile && selectedCategory.CatimageVert
          ? baseUrl + selectedCategory.CatimageVert
          : baseUrl + selectedCategory.CatimageOrizz
      "
      [alt]="selectedCategory.title"
      class="format-hero-img"
    />
    <div class="format-hero-overlay"></div>
    <div class="format-hero-content">
      <h1>{{ selectedCategory.title | uppercase }}</h1>
      <div class="format-metadata">
        <!-- Se la lunghezza di availableSeasons è 1, usa 'STAGIONE', altrimenti 'STAGIONI' -->
        <span
          >{{ availableSeasons.length }}
          {{ availableSeasons.length === 1 ? "STAGIONE" : "STAGIONI" }}</span
        >

        <span>• FULL HD</span>

        <!-- Se la lunghezza di videos è 1, usa 'EPISODIO', altrimenti 'EPISODI' -->
        <span
          >• {{ selectedCategory.videos.length }}
          {{
            selectedCategory.videos.length === 1 ? "EPISODIO" : "EPISODI"
          }}</span
        >
      </div>
      <p class="format-description">{{ selectedCategory.description }}</p>
      <div class="format-controls">
        <button
          class="control-btn play-btn"
          (click)="goToVideo(selectedCategory.videos[0].id)"
        >
          <i class="fa-solid fa-play"></i> PLAY
        </button>
        <button
          class="control-btn favorite-btn"
          (click)="toggleFavorite()"
          [ngClass]="{ saved: isFavorite() }"
          *ngIf="isLoggedIn"
          [attr.aria-pressed]="isFavorite()"
          [attr.title]="
            isFavorite() ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti'
          "
        >
          <i
            [ngClass]="
              isFavorite()
                ? 'fa-solid fa-heart favorite-filled'
                : 'fa-regular fa-heart'
            "
          ></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Contenuto principale della pagina stagioni/episodi -->
  <div class="episodes-section">
    <div class="episodes-header">
      <h2>EPISODI</h2>
      <!-- Selettore Stagioni -->
      <div *ngIf="availableSeasons.length > 1" class="season-selector-wrapper">
        <select
          [(ngModel)]="selectedSeason"
          (change)="filterEpisodesBySeason()"
          class="season-selector"
        >
          <option *ngFor="let season of availableSeasons" [ngValue]="season">
            SEASON {{ season }}
          </option>
        </select>
        <i class="fa-solid fa-chevron-down season-arrow-icon"></i>
      </div>
    </div>

    <div class="episodes-content-wrapper" (mouseleave)="onEpisodeLeave()">
      <!-- Lista degli episodi -->
      <div class="episodes-list">
        <ng-container *ngIf="filteredEpisodes.length > 0; else noEpisodes">
          <div
            *ngFor="
              let episode of filteredEpisodes;
              trackBy: trackById;
              let i = index
            "
            class="episode-card"
            (click)="goToVideo(episode.id)"
            (mouseenter)="onEpisodeHover(episode)"
          >
            <div class="episode-thumbnail-container">
              <img [src]="episode.thumbnail" [alt]="episode.title" />
              <div class="episode-play-overlay">
                <i class="fa-solid fa-play play-icon"></i>
              </div>
            </div>
            <div class="episode-details">
              <p class="episode-number">
                <span
                  >S{{ episode.season }} EPISODIO {{ i + 1 }} -
                  {{ episode.duration | formatDuration }} -
                  {{ episode.visuals | viewsFormat }}</span
                >
                <i class="fa-solid fa-eye"></i>
              </p>
              <h3 class="episode-title">{{ episode.title | uppercase }}</h3>
              <p class="episode-short-desc">{{ episode.description }}</p>
            </div>
          </div>
        </ng-container>
        <ng-template #noEpisodes>
          <p class="no-content-message">
            Nessun episodio trovato per questa stagione.
          </p>
        </ng-template>
      </div>

      <!-- Pannello dettagli al passaggio del mouse (sticky) -->
      <div *ngIf="hoveredEpisode" class="episode-details-panel">
        <img
          [src]="hoveredEpisode.thumbnail"
          [alt]="hoveredEpisode.title"
          class="panel-img"
        />
        <div class="panel-info">
          <h2>{{ hoveredEpisode.title }}</h2>
          <div class="panel-metadata">
            <span>{{ hoveredEpisode.duration | formatDuration }}</span>
            <span
              >•
              {{ hoveredEpisode.visuals | viewsFormat }} VISUALIZZAZIONI</span
            >
          </div>
          <p class="panel-description">{{ hoveredEpisode.description }}</p>
          <button
            class="watch-video-btn"
            (click)="goToVideo(hoveredEpisode.id)"
          >
            GUARDA ORA
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
